

---------------------------
các việc cần làm trên database
----------------------------

1. xóa cac chuogn trinh khuyến mãi link
	DELETE FROM `dala_discount_program_product_link`;
	DELETE FROM `dala_discount_program_details`;
	DELETE FROM `dala_discount_program_gift_link`;

	
	ALTER TABLE `dala_discount_program_product_link` 
	ADD `dala_discount_program_product_link_discount_program_id` INT NOT NULL 
	AFTER `dala_discount_program_product_link_discount_program_details_id`;


	DROP TRIGGER trig_discount_program_product_link_after_insert; 
	DROP TRIGGER trig_discount_program_product_link_delete; 
	DROP TRIGGER trig_discount_program_product_link_insert; 
	DROP TRIGGER trig_discount_program_product_link_update; 
	DROP TRIGGER trig_discount_program_product_link_update_after; 

	DROP TRIGGER trig_discount_program_delete;


	ALTER TABLE `dala_discount_program` 
	CHANGE `dala_discount_program_gift_type` `dala_discount_program_gift_type` INT NOT NULL DEFAULT '0' 
	COMMENT '[0:discount thuong] [1: discount mua 1 tang 1] [2 : gia sỉ]';





	DROP TABLE IF EXISTS `dala_products_speciality_price_meta`;
	CREATE TABLE IF NOT EXISTS `dala_products_speciality_price_meta` (
	  `dala_products_speciality_price_meta_ID` int NOT NULL AUTO_INCREMENT,
	  `dala_products_speciality_price_meta_discount_product_link_id` int NOT NULL,
	  `dala_products_speciality_price_meta_product_id` int NOT NULL,
	  `dala_products_speciality_price_meta_from` int NOT NULL,
	  `dala_products_speciality_price_meta_to` int NOT NULL,
	  `dala_products_speciality_price_meta_price` double NOT NULL,
	  PRIMARY KEY (`dala_products_speciality_price_meta_ID`)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci COMMENT='giá càng nhiều càng rẻ';
	COMMIT;









	-- 
	-- 
	-- 
	-- 
	-- 
	-- star
	START TRANSACTION;
	--
	-- data type
	DROP TRIGGER  IF EXISTS  trig_discount_program_product_link_insert;
	--

	DELIMITER $$ 
	CREATE TRIGGER trig_discount_program_product_link_insert BEFORE INSERT ON dala_discount_program_product_link 
	FOR EACH ROW  
	BEGIN  

		SET @checkID = (select 	dala_discount_program_product_link_ID 
			from dala_discount_program_product_link  
			where 	
			dala_discount_program_product_link_discount_program_id  =  NEW.dala_discount_program_product_link_discount_program_id 
			and 
			dala_discount_program_product_link_product_speciality_id  =  NEW.dala_discount_program_product_link_product_speciality_id  
			);
		IF (@checkID > 0) THEN  
			SIGNAL SQLSTATE '12341' 
			SET MESSAGE_TEXT = 'trig_discount_program_product_link_insert_double'; 	
		END IF;	
		
		
		SET @checkID2 = (select dala_discount_program_product_link_ID 
			from dala_discount_program_product_link  
			where 	
			dala_discount_program_product_link_product_speciality_id  =  NEW.dala_discount_program_product_link_product_speciality_id   
			and 
			dala_discount_program_product_link_discount_program_id  > 0  
			);
		IF (@checkID2 > 0) THEN  
			SIGNAL SQLSTATE '12342' 
			SET MESSAGE_TEXT = 'trig_discount_program_product_link_insert_bug'; 	
		END IF;			
		
		
	END $$
	DELIMITER ;
	--
	--
	--
	-- commit 
	COMMIT;
	-- 
	-- 
	-- 
	-- 
	-- 
	-- 




	-- 
	-- 
	-- 
	-- 
	-- 
	-- star
	START TRANSACTION;
	--
	-- data type
	DROP TRIGGER  IF EXISTS  trig_discount_program_product_link_after_delete;
	--

	DELIMITER $$ 
	CREATE TRIGGER trig_discount_program_product_link_after_delete AFTER DELETE ON dala_discount_program_product_link 
	FOR EACH ROW  
	BEGIN  

		DELETE FROM  dala_discount_program_gift_link 
		where 	
		dala_discount_program_gift_link_discount_program_product_link_id  =  
		OLD.dala_discount_program_product_link_ID ;
		
		DELETE FROM  dala_products_speciality_price_meta 
		where 	
		dala_products_speciality_price_meta_discount_product_link_id  =  
		OLD.dala_discount_program_product_link_ID ;	


	
	END $$
	DELIMITER ;
	--
	--
	--
	-- commit 
	COMMIT;
	-- 
	-- 
	-- 
	-- 
	-- 
	-- 







	-- 
	-- 
	-- 
	-- 
	-- 
	-- star
	START TRANSACTION;
	--
	-- data type
	DROP TRIGGER  IF EXISTS  trig_discount_program_gift_link_insert;
	--

	DELIMITER $$ 
	CREATE TRIGGER trig_discount_program_gift_link_insert BEFORE INSERT ON dala_discount_program_gift_link  
	FOR EACH ROW  
	BEGIN  

		SET @checkID = (select 	dala_discount_program_gift_link_ID  
			from dala_discount_program_gift_link 
			where 	
			dala_discount_program_gift_link_product_speciality_id  =  NEW.dala_discount_program_gift_link_product_speciality_id  
			and 
			dala_discount_program_gift_link_product_speciality_gift_id  =  NEW.dala_discount_program_gift_link_product_speciality_gift_id   
			);
		IF (@checkID > 0) THEN  
			SIGNAL SQLSTATE '12341' 
			SET MESSAGE_TEXT = 'trig_discount_program_gift_link_double'; 	
		END IF;	
		
	END $$
	DELIMITER ;
	--
	--
	--
	-- commit 
	COMMIT;
	-- 
	-- 
	-- 
	-- 
	-- 






if( !req.session.token ){
	res.send('<h1 style="text-align:center;">Vui lòng đăng nhập</h1>' );
	return;
}	


-- --------------------------------------------------------------------------------------------------------------------------





------------------------------------
	-- 2022/1/12
------------------------------------

- các view đã sử dụng
	* dala_view_count_product_sale
	* dala_view_order_details_by_user
















   
   
   
   